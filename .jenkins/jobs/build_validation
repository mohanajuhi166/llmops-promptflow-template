@Library('shared-library@feature/add-shared-library') _
pipeline {
    agent any

    options {
        // This is required if you want to clean before build
        skipDefaultCheckout(true)
    }

    parameters {
        string(name: 'flow_type', defaultValue: 'named_entity_recognition', description: 'The flow use-case to validate')
    }

    triggers {
        GenericTrigger(
                genericVariables: [
                    [key: 'ref', value: '$.ref']
                ],
                genericHeaderVariables: [
                ],
                causeString: 'Triggered on $action',
                token: 'JENKINS_URL',
                printContributedVariables: true,
                printPostContent: false,
                silentResponse: false,
                regexpFilterText: '$ref',
                regexpFilterExpression: 'refs/heads/feature/*'
         )
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                checkout scm
            }
        }

        stage('Load Dependencies') {
            steps {
                installRequirements('build_validation_requirements')
                sh 'az version'
            }
        }

        stage('Azure Login') {
            steps {
                azureLogin()
                }
            }

        stage('Load Azure Subscription Details') {
            steps {
                withCredentials([azureServicePrincipal('AZURE_CREDENTIALS')]) {
                    sh '''
                    export subscriptionId=$(az account show --query id -o tsv)
                    echo "SUBSCRIPTION_ID=$AZURE_SUBSCRIPTION_ID"
                    '''
                }
            }
        }

        stage('Execute Unit Tests') {
            steps {
                withPythonEnv('/usr/bin/python3.9') {
                    sh "pytest ${params.flow_type}/tests --junitxml=junit/test-results.xml --cov=. --cov-report=xml"
                }
            }
        }

        stage('Publish Unit Test Results') {
            steps {
                archiveArtifacts artifacts: '**/test-*.xml', fingerprint: true
            }
        }
    }
}